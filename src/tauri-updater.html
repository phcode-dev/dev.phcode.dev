<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tauri Updater Hidden Window</title>
    <script>
        const UPDATE_COMMANDS = {
            GET_STATUS: "GET_STATUS"
        };
        const UPDATE_EVENT = {
            STATUS: "STATUS",
            LOG_ERROR: "LOG_ERROR"
        };
        const UPDATE_STATUS = {
            STARTED: "STARTED",
            FAILED: "FAILED",
            FAILED_UNKNOWN_OS: "FAILED_UNKNOWN_OS",
            INSTALLED: "INSTALLED"
        };
        let status = UPDATE_STATUS.STARTED;
        window.__TAURI__.event.listen("updateCommands", (receivedEvent)=> {
            console.log("Updater received Event updateCommands", receivedEvent);
            const {command, data} = receivedEvent.payload;
            if(command === UPDATE_COMMANDS.GET_STATUS){
                sendUpdateEvent(UPDATE_EVENT.STATUS, status);
            }
        });
        function sendUpdateEvent(eventName, data) {
            return window.__TAURI__.event.emit('updater-event', {eventName, data});
        }
        sendUpdateEvent(UPDATE_EVENT.STATUS, status);

        async function updateMacOS() {
            try {
                await __TAURI__.updater.installUpdate();
                status = UPDATE_STATUS.INSTALLED;
                sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.INSTALLED);
            } catch (e) {
                status = UPDATE_STATUS.FAILED;
                sendUpdateEvent(UPDATE_EVENT.LOG_ERROR, e.stack);
                sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.FAILED);
            }
        }

        async function updateLinux() {
            try {
                const command = new __TAURI__.shell.Command('run-update-linux-command',
                    ['-e', 'wget -qO- https://updates.phcode.io/linux/installer.sh | bash -s -- --upgrade'])
                const result = await command.execute();
                if(result.code !== 0){
                    status = UPDATE_STATUS.FAILED;
                    sendUpdateEvent(UPDATE_EVENT.LOG_ERROR, result.stderr);
                    sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.FAILED);
                    return;
                }
                status = UPDATE_STATUS.INSTALLED;
                sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.INSTALLED);
            } catch (e) {
                status = UPDATE_STATUS.FAILED;
                sendUpdateEvent(UPDATE_EVENT.LOG_ERROR, e.stack);
                sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.FAILED);
            }
        }

        async function updateWindows() {

        }

        async function update() {
            const platform = await __TAURI__.os.platform();
            if(platform === 'darwin'){
                await updateMacOS();
            } else if(platform === 'linux'){
                await updateLinux();
            } else if(platform === 'win32'){
                await updateWindows();
            } else {
                status = UPDATE_STATUS.FAILED_UNKNOWN_OS;
                sendUpdateEvent(UPDATE_EVENT.STATUS, UPDATE_STATUS.FAILED_UNKNOWN_OS);
            }
        }
        update();
    </script>
</head>
<body>
 Updating App... <br>
 This should be a hidden window if you are seeing this, something's broken, or you are debugging updates.
</body>
</html>